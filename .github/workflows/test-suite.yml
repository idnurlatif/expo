name: Test Suite

on:
  workflow_dispatch: {}
  push:
    branches: [main, 'sdk-*']
    paths:
      - .github/workflows/test-suite.yml
      - apps/bare-expo/**
      - apps/test-suite/**
      - packages/**
      - yarn.lock
  pull_request:
    paths:
      - .github/workflows/test-suite.yml
      - apps/bare-expo/**
      - apps/test-suite/**
      - packages/**
      - yarn.lock
      # Ignore Expo CLI for now...
      - '!packages/@expo/cli/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ios:
    runs-on: macos-12
    steps:
      - name: 👀 Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: 🔨 Switch to Xcode 14.1
        run: sudo xcode-select --switch /Applications/Xcode_14.1.app
      - name: 🍺 Install required tools
        run: |
          brew tap wix/brew
          brew install applesimutils
          brew install watchman
      - name: ➕ Add `bin` to GITHUB_PATH
        run: echo "$(pwd)/bin" >> $GITHUB_PATH
      - name: 💎 Setup Ruby and install gems
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - name: ♻️ Restore caches
        uses: ./.github/actions/expo-caches
        id: expo-caches
        with:
          yarn-workspace: 'true'
          yarn-tools: 'true'
          bare-expo-pods: 'true'
      - name: 🧶 Install node modules in root dir
        if: steps.expo-caches.outputs.yarn-workspace-hit != 'true'
        run: yarn install --frozen-lockfile
      - name: 🕵️ Debug CocoaPods lockfiles
        run: git diff Podfile.lock Pods/Manifest.lock
        working-directory: apps/bare-expo/ios
        continue-on-error: true
      - name: ⚛️ Display React Native config
        run: yarn react-native config
        working-directory: apps/bare-expo
      - name: 🌳 Display pod environment
        run: pod env
        working-directory: apps/bare-expo/ios
      - name: 🥥 Install pods in apps/bare-expo/ios
        if: steps.expo-caches.outputs.ios-pods-hit != 'true'
        run: pod install
        working-directory: apps/bare-expo/ios
      - name: 🧹 Clean Detox
        run: yarn detox:clean
        working-directory: apps/bare-expo
      - name: 🏗️ Build iOS project for Detox
        run: yarn ios:detox:build:release
        working-directory: apps/bare-expo
        timeout-minutes: 30
      - name: Run tests
        run: yarn ios:detox:test:release
        working-directory: apps/bare-expo
      - name: Store images of build failures
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bare-expo-artifacts
          path: apps/bare-expo/artifacts
